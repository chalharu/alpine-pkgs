# Contributor: Mitsuharu Seki <mitsu1986@gmail.com>
# Maintainer: Mitsuharu Seki <mitsu1986@gmail.com>
pkgname=kanidm
# renovate: datasource=github-tags depName=kanidm/kanidm
pkgver=1.3.3
pkgrel=0
pkgdesc="Kanidm: A simple, secure and fast identity management platform"
url="https://github.com/kanidm/kanidm"
arch="x86_64 aarch64"
license="Apache-2.0"
depends=""
makedepends="eudev-dev gcc libc-utils make musl-dev openssl-dev openssl-libs-static pkgconfig rustup rsync bc bash"
checkdepends=""
install=""
subpackages="kanidm-server:server kanidm-client:client kanidm-unixd-clients:unixd_clients"
source="$pkgname-$pkgver.tar.gz::https://github.com/kanidm/kanidm/archive/refs/tags/v$pkgver.tar.gz"
builddir="$srcdir/kanidm-$pkgver"
options=""

build() {
	rustup-init -y
	. "$HOME/.cargo/env"
	cargo install wasm-pack
	cargo install wasm-bindgen-cli
	export KANIDM_BUILD_PROFILE=release_linux
	cargo build --locked --release --target-dir target \
      --package daemon \
      --package kanidm-ipa-sync \
      --package kanidm_tools \
      --package kanidm_unix_int
	make webui
	strip target/release/kanidmd
	strip target/release/kanidm
}

check() {
	# make test
	return 0
}

package() {
	depends="kanidm-server kanidm-client kanidm-unixd-clients"
	return 0
}

server() {
	cd "$builddir"
	install -Dm755 -t "$subpkgdir"/usr/bin/ \
		target/release/kanidmd
	install -Dm755 -t "$subpkgdir"/usr/bin/ \
		target/release/kanidm-ipa-sync
	
	install -dv "$subpkgdir"/usr/share/kanidm/ui/
	cp -r server/web_ui/pkg "$pkgdir"/usr/share/kanidm/ui/
}

client() {
	cd "$builddir"
	install -Dm755 -t "$subpkgdir"/usr/bin/ \
		target/release/kanidm
}

unixd_clients() {
	cd "$builddir"
	install -Dm755 -t "$subpkgdir"/usr/bin/ \
		target/release/kanidm_ssh_authorizedkeys
	install -Dm755 -t "$subpkgdir"/usr/bin/ \
		target/release/kanidm_ssh_authorizedkeys_direct
	install -Dm755 -t "$subpkgdir"/usr/bin/ \
		target/release/kanidm-unix
	install -Dm755 -t "$subpkgdir"/usr/bin/ \
		target/release/kanidm_unixd
	install -Dm755 -t "$subpkgdir"/usr/bin/ \
		target/release/kanidm_unixd_tasks
}

sha512sums="
0e00634964bef76c97c15e129d43350cab8d71ea9504751a2227c0a60edddd004f682213c639aa43d9f192d6e85138aa4e42312b8d8d5c352f02899813ab6fe0  kanidm-1.3.3.tar.gz
"
